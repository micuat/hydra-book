<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Hydra Book</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="Description" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Chivo:300,400,700"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/docsify/lib/themes/vue.css"
    />
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/hydra-synth"></script>
  </head>

  <body>
    <div id="app"></div>
    <script>
      let hydra, hydraCanvas;
      hydraCanvas = document.createElement("canvas");
      hydraCanvas.width = 512;
      hydraCanvas.height = 512;
      hydraCanvas.id = "hydraCanvas";

      hydra = new Hydra({
        canvas: hydraCanvas,
        detectAudio: false,
        enableStreamCapture: false,
        width: 512,
        height: 512
      });
      window.$docsify = {
        auto2top: true,
        loadSidebar: true,
        subMaxLevel: 3,
        name: "",
        repo: "",
        plugins: [
          // https://github.com/baku89/glisp/blob/master/docs/index.html
          function(hook, vm) {
            hook.afterEach((html, next) => {
              html = html.replace(
                /data-lang="javascript"/gi,
                'data-lang="javascript" class="hydra-code"'
              );
              next(html);
            });

            const placeholders = [];

            hook.doneEach(() => {
              const isNotTop = document.URL[document.URL.length - 1] !== "/";
              const codeBlocks = document.querySelectorAll("pre.hydra-code");

              codeBlocks.forEach(preEl => {
                const parentEl = preEl.parentElement;
                const codeEl = preEl.firstChild;

                if (isNotTop) {
                  const linkEl = document.createElement("p");
                  linkEl.innerHTML = `<a href="https://hydra.ojack.xyz/?code=${btoa(
                    encodeURIComponent(codeEl.textContent)
                  )}" target="_blank" class="openin"><img src="symbols/external.png" class="external">open in editor</a>`;

                  preEl.insertAdjacentElement("afterend", linkEl);
                } else {
                  preEl.style.display = "none";
                }

                const placeholder = document.createElement("div");
                placeholder.style.width = "512px";
                placeholder.style.height = "512px";
                placeholder.classList.add("hydracontainer");
                placeholders.push(placeholder);
                preEl.insertAdjacentElement("afterend", placeholder);

                var observer = new IntersectionObserver(
                  function(entries) {
                    if (entries[0].isIntersecting === true) {
                      hush();
                      solid(0, 0, 0, 0).out(o0);
                      solid(0, 0, 0, 0).out(o1);
                      solid(0, 0, 0, 0).out(o2);
                      solid(0, 0, 0, 0).out(o3);
                      render(o0);
                      setTimeout(() => {
                        eval(codeEl.textContent);
                      }, 60);
                      placeholder.appendChild(hydraCanvas);
                    }
                  },
                  { threshold: [0.5] }
                );

                observer.observe(placeholder);
              });
            });

            hook.mounted(() => {
              // Called after initial completion. Only trigger once, no arguments.
              // document.querySelector("main").appendChild(hydraCanvas);
            });
          }
        ]
      };
      window.onmessage = e => {
        console.log(e);
      };
    </script>
    <script src="//cdn.jsdelivr.net/npm/docsify/lib/docsify.min.js"></script>
  </body>
</html>
